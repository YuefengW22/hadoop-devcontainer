services:
  nn:
    image: rbda-hadoop:3.3.6
    container_name: nn
    hostname: nn
    environment:
      ROLE: namenode
    volumes:
      - nn-data:/data/nn
      - ../conf:/etc/hadoop:ro
    ports:
      - "9870:9870"   # NameNode UI
      - "9000:9000"   # HDFS RPC
    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -fsS http://localhost:9870/ >/dev/null"]
      interval: 10s
      timeout: 3s
      retries: 20
    mem_limit: 2g
    cpus: 1.0
    networks: [hadoop-net]

  rm:
    image: rbda-hadoop:3.3.6
    container_name: rm
    hostname: rm
    environment:
      ROLE: resourcemanager
    volumes:
      - ../conf:/etc/hadoop:ro
    ports:
      - "8088:8088"   # RM UI
    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -fsS http://localhost:8088/ >/dev/null"]
      interval: 10s
      timeout: 3s
      retries: 20
    mem_limit: 2g
    cpus: 1.0
    networks: [hadoop-net]
    depends_on:
      nn:
        condition: service_healthy

  w1:
    image: rbda-hadoop:3.3.6
    container_name: w1
    hostname: w1
    environment:
      ROLE: worker
    volumes:
      - w1-dn:/data/dn
      - ../conf:/etc/hadoop:ro
    ports:
      - "9864:9864"   # DataNode UI (w1)
    mem_limit: 3g
    cpus: 2.0
    networks: [hadoop-net]
    depends_on:
      nn:
        condition: service_healthy
      rm:
        condition: service_healthy

  w2:
    image: rbda-hadoop:3.3.6
    container_name: w2
    hostname: w2
    environment:
      ROLE: worker
    volumes:
      - w2-dn:/data/dn
      - ../conf:/etc/hadoop:ro
    ports:
      - "9865:9864"   # DataNode UI (w2)
    mem_limit: 3g
    cpus: 2.0
    networks: [hadoop-net]
    depends_on:
      nn:
        condition: service_healthy
      rm:
        condition: service_healthy

  client:
    image: rbda-hadoop:3.3.6
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    container_name: client
    hostname: client
    environment:
      ROLE: client
    volumes:
      - ../conf:/etc/hadoop:ro
    working_dir: /workspaces/hadoop-devcontainer
    stdin_open: true
    tty: true
    networks: [hadoop-net]
    depends_on:
      nn:
        condition: service_healthy
      rm:
        condition: service_healthy

networks:
  hadoop-net:

volumes:
  nn-data:
  w1-dn:
  w2-dn:
